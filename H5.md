# H5 Loppuhuipennus

Tässä tehtävässä tarkoitus oli jatkaa viime viikolla aloitettu projekti loppuun. 

Viimeisenä vaiheena käsin tehtynä masterilla otin vielä käyttöön automaattiset päivitykset komennolla `sudo dpkg-reconfigure unattended-upgrades`. 

![Screenshot](https://github.com/user-attachments/assets/91ea8fa8-553d-4980-94db-50442ed94902)

Seuraavaksi lähdin määrittelemään salt-tiloja. Loin aluksi /srv/salt -kansioon uuden kansion updates. Kopioin tänne /etc/apt/apt.conf.d -kansiosta tiedostot 20auto-upgrades
ja 50unattended-upgrades. Lisäksi loin vielä init.sls -tiedoston. Ongelmaksi muodostui se, kun yritin ottaa päivitykset käyttöön komennolla `sudo dpkg-reconfigure unattended-upgrades`. Tämä komento vaatii käyttäjän syötettä (yes), jotta komento voi jatkua. Init.sls -tiedoston ajo jäi rullaamaan ikuisesti, joten oletin, että vika on tuossa kohdassa. Tässä toimimaton init.sls -tiedosto:

![Screenshot](https://github.com/user-attachments/assets/87a5a05d-0df7-4c22-a1fd-9e012a0115e3)

Edellisessä kuvassa siis kohta cmd.run on väärin, mutta en tiedä, millä tavoin saisin käyttäjän syötteen mukaan komentoon. Tuo kohta jäi siis ratkaisematta.

Kokeilin ajaa tiedoston ilman kyseistä kohtaa ja ajo suoritettiin onnistuneesti. Init.sls -tiedoston sisältö:

![Screenshot](https://github.com/user-attachments/assets/7f7abf04-7d71-41e4-8a4c-96aad90fc1e3)

Init.sls -tiedostossa aluksi varmistetaan, että unattended-upgrades on asennettu. Tämän jälkeen kopioidaan masterilta minionille kaksi tiedostoa kansioon /etc/apt/apt.conf.d. Lopuksi vielä käynnistetään demoni uudelleen. Onnistunut ajo minionille:

![Screenshot](https://github.com/user-attachments/assets/aac839b1-a066-4de7-a3e0-4d9586b3da1b)

![Screenshot](https://github.com/user-attachments/assets/8d69cddd-f22c-494f-9ad1-70d7dbc06a77)

Ja komennot olivat idempotentteja:

![Screenshot](https://github.com/user-attachments/assets/572075b1-4b0e-4812-bfba-85981ca8c380)

![Screenshot](https://github.com/user-attachments/assets/950bef59-0f39-4645-9082-9a1841307ea8)



# Lähteet:

https://terokarvinen.com/palvelinten-hallinta/

https://wiki.debian.org/UnattendedUpgrades

https://help.ubuntu.com/community/AutomaticSecurityUpdates

https://docs.saltproject.io/en/latest/ref/states/all/salt.states.file.html

https://docs.saltproject.io/en/latest/ref/states/all/salt.states.service.html

https://docs.saltproject.io/en/latest/ref/states/all/salt.states.cmd.html


